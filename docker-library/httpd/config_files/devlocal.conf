<VirtualHost *:80>
        ServerAdmin devuser@example.com
        
        ServerName %{ENV:DEV_DOMAIN}
        ServerAlias *.%{ENV:DEV_DOMAIN}
        
        Define DEFAULT_DOCUMENT_ROOT /var/www/

        <IfModule mod_lua.c>
                # Carga el script Lua antes de que se procesen las reglas de reescritura.
                # Esto establece la variable Apache 'docroot_path'
                LuaMapHandler "/etc/apache2/lua/resolve_docroot.lua"
                

                DocumentRoot ${DEFAULT_DOCUMENT_ROOT}
                
                # Una regla de reescritura simple para forzar el DocumentRoot correcto
                # Esta regla es el reemplazo de TODAS tus reglas de Level 1-4.
                # Usa la variable de entorno seteada por Lua (r:set_var)
                RewriteEngine On
                RewriteRule ^/(.*)$ %{ENV:docroot_path}/$1 [PT]
        </IfModule>

        <IfModule !mod_lua.c>
                DocumentRoot ${DEFAULT_DOCUMENT_ROOT}
        </IfModule>      


        <IfModule mod_dir.c>
                DirectoryIndex index.html index.cgi index.pl index.php index.xhtml index.htm
        </IfModule>

    
        SetEnvIf Host ".*--p83.*" PHP_VERSION=83
        SetEnvIf Host ".*--p84.*" PHP_VERSION=84

        # Websocket config
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/?(.*) "ws://phpwebsocket:8080/$1" [P,L]

        <FilesMatch ".+\.php$">
                <If "reqenv('PHP_VERSION') -eq 83">
                        SetHandler "proxy:fcgi://php83dev:9001"
                </If>
                <If "reqenv('PHP_VERSION') -eq 84">
                        SetHandler "proxy:fcgi://php84dev:9001"
                </If>
        </FilesMatch>

        <Directory /home/devuser/public_html/>
                Options FollowSymLinks
                AllowOverride All
                Require all granted
        </Directory>

</VirtualHost>